

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>CONCURRENCY IN PYTHON &mdash; PyMiami  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="#" class="icon icon-home"> PyMiami
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">CONCURRENCY IN PYTHON</a></li>
<li><a class="reference internal" href="#second-part-python-async-i-o">Second Part: Python Async I/O</a><ul>
<li><a class="reference internal" href="#contact-information">Contact Information</a></li>
<li><a class="reference internal" href="#important-note">Important Note</a></li>
<li><a class="reference internal" href="#references">References</a></li>
<li><a class="reference internal" href="#documents-and-papers">Documents and Papers</a></li>
</ul>
</li>
<li><a class="reference internal" href="#at-the-beginning-there-were-threads">At the beginning there were threads..</a></li>
<li><a class="reference internal" href="#and-then-we-were-given-a-breath-of-life-async-i-o">…And then we were given a breath of life Async I/O</a><ul>
<li><a class="reference internal" href="#how-the-heck-does-async-await-work-in-python-brett-cannon-11">How the heck does async/await work in Python ? Brett  Cannon [11]</a></li>
<li><a class="reference internal" href="#iterables-and-iterator-and-generator-function">Iterables and Iterator and Generator Function</a></li>
<li><a class="reference internal" href="#generator-functions-yield-appears">Generator Functions ( yield appears)</a></li>
<li><a class="reference internal" href="#coroutines-and-its-importance-in-async-operations">Coroutines and its importance in async operations</a></li>
<li><a class="reference internal" href="#interlude-generators-are-not-coroutines">Interlude : Generators are not Coroutines</a></li>
<li><a class="reference internal" href="#event-loops">Event Loops :</a></li>
<li><a class="reference internal" href="#his-name-is-yuri-selivanov-or-async-await-to-take-us-outside-of-the-chaos">His name is Yuri Selivanov, or,  “async / await to take us outside of the chaos”</a></li>
<li><a class="reference internal" href="#so-at-the-end-what-we-need-to-know-so-far">So at the end, what we need to know so far</a></li>
<li><a class="reference internal" href="#andrew-svetlov-aiohttp">Andrew Svetlov : aiohttp</a></li>
</ul>
</li>
</ul>
</div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="#">PyMiami</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="#">Docs</a> &raquo;</li>
        
      <li>CONCURRENCY IN PYTHON</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/index.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="concurrency-in-python">
<h1>CONCURRENCY IN PYTHON<a class="headerlink" href="#concurrency-in-python" title="Permalink to this headline">¶</a></h1>
</div>
<div class="section" id="second-part-python-async-i-o">
<h1>Second Part: Python Async I/O<a class="headerlink" href="#second-part-python-async-i-o" title="Permalink to this headline">¶</a></h1>
<blockquote>
<div><p>Created by David Gutierrez for PyMiami.</p>
<p>FIU School of Engineering and Computers hold this FREE events monthly.</p>
</div></blockquote>
<div class="section" id="contact-information">
<h2>Contact Information<a class="headerlink" href="#contact-information" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>David Gutierrez.
email: david &#64; pymiami . org</p>
<p>Joint our group social accounts to keep updated about upcoming events:</p>
<blockquote>
<div><p><a class="reference external" href="https://twitter.com/Py_Miami">Twitter</a></p>
<p><a class="reference external" href="https://www.facebook.com/PythonDevelopersMiami/">Facebook</a></p>
</div></blockquote>
<dl class="simple">
<dt>Do you need help or training?</dt><dd><p>Contact us at david &#64; pythonsoftware.solutions</p>
</dd>
</dl>
</div></blockquote>
</div>
<div class="section" id="important-note">
<h2>Important Note<a class="headerlink" href="#important-note" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>All content in this tutorial has been taken from the references named below. What I have done is looking for some of the best
, relevant information and  organize it in a way that better help understands the subject .
I find this much better than re-create a content , and also because the creators are extremely skilled and experienced
personalities ,and as such are  much more capable and has much more knowledge than I have.</p>
<p>This course is also a way of recognition to the creators of the content and their live long effort and their
contribution to Python.</p>
<p>Take a time to follow them in their Social media Links below , and check their companies , courses ,
training and what they do. You will benefit immensely.</p>
<p>I will take the freedom to start by mention all the references,  and documentation used in this Tutorial.</p>
</div></blockquote>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul class="simple">
<li><p>1- Yury Selivanov,  <a class="reference external" href="https://www.youtube.com/watch?v=2ZFFv-wZ8_g">Async await and asyncio in Python 3.6 and beyond PyCon 2017.</a></p></li>
<li><p>2- Miguel Grinberg,  <a class="reference external" href="https://www.youtube.com/watch?v=iG6fr81xHKA">Asynchronous Python for the Complete Beginner PyCon 2017.</a></p></li>
<li><p>3- John Reese, <a class="reference external" href="https://www.youtube.com/watch?v=0kXaLh8Fz3k">Thinking Outside the GIL with AsyncIO and Multiprocessing - PyCon 2018.</a></p></li>
<li><p>4- Mariatta Wijaya, <a class="reference external" href="https://www.youtube.com/watch?v=OxzVApXKWYM">Hands-on Intro to aiohttp - PyCon 2019] video.</a></p></li>
<li><p>5- Andrew Svetlov, <a class="reference external" href="https://us-pycon-2019-tutorial.readthedocs.io/asyncio_intro.html">Hands-on Intro to aiohttp - PyCon 2019] slides.</a></p></li>
<li><p>6- Luciano Ramalho, <a class="reference external" href="https://www.amazon.com/Fluent-Python-Concise-Effective-Programming/dp/1491946008">Fluent Python 1st Edition,  book , Chapter 16, Coroutines page 480.</a></p></li>
<li><p>7- Brett Cannon, <a class="reference external" href="https://snarky.ca/how-the-heck-does-async-await-work-in-python-3-5/).">How async/await works in Python3.5.</a></p></li>
<li><p>8- David Beazley, <a class="reference external" href="https://www.youtube.com/watch?v=lYe8W04ERnY">Python Brasil 2015 keynote and his curio framework is proof of above concept</a></p></li>
<li><p>9- David Beazley, <a class="reference external" href="http://www.dabeaz.com/coroutines/">Curios Course on Coroutines and Concurrency,</a></p></li>
<li><p>10- Łukasz Langa, <a class="reference external" href="https://www.youtube.com/watch?v=l4Nn-y9ktd4">Thinking In Coroutines - PyCon 2016,</a></p></li>
<li><p>11- Brett Cannon, <a class="reference external" href="https://snarky.ca/how-the-heck-does-async-await-work-in-python-3-5/">How the heck does async/await work in Python 3.5?,</a></p></li>
<li><p>12- Raymond Hettinger, <a class="reference external" href="https://www.youtube.com/watch?v=9zinZmE3Ogk&amp;t=55s">Keynote on Concurrency, PyBay 2017</a></p></li>
<li><p>13 -Doug Hellman, <a class="reference external" href="https://www.amazon.com/Python-Standard-Library-Example-Developers-ebook/dp/B072QZZDV7">The Python 3 Standard Library by Example</a></p></li>
<li><p>14 -Dusty Phillips, <a class="reference external" href="https://www.packtpub.com/application-development/python-3-object-oriented-programming-third-edition">Python 3 Object-Oriented Programming 3rd Edition</a>.</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="documents-and-papers">
<h2>Documents and Papers<a class="headerlink" href="#documents-and-papers" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul class="simple">
<li><p>10- <a class="reference external" href="https://pypi.org/project/certifi/">certifi documentation</a>.</p></li>
<li><p>11- <a class="reference external" href="https://docs.python.org/3/library/ssl.html#ssl.SSLContext">SSL context documentation</a>.</p></li>
<li><p>12- <a class="reference external" href="https://docs.aiohttp.org/en/stable/">aiohttp documentation,</a>.</p></li>
<li><p>13- <a class="reference external" href="https://www.python.org/dev/peps/pep-0492/#id34">PEP 492, Coroutines with async and await syntax,</a>.</p></li>
<li><p>14- <a class="reference external" href="https://docs.python.org/3/library/asyncio-eventloop.html">Python Event loop,</a>.</p></li>
<li><p>15- <a class="reference external" href="https://docs.python.org/3/library/asyncio-task.html#coroutines">Coroutines and tasks,</a>.</p></li>
<li><p>16- <a class="reference external" href="https://www.python.org/dev/peps/pep-0380/">PEP 380, Syntax for Delegating to a Subgenerator.</a>.</p></li>
</ul>
</div></blockquote>
<div class="toctree-wrapper compound">
</div>
</div>
</div>
<div class="section" id="at-the-beginning-there-were-threads">
<h1>At the beginning there were threads..<a class="headerlink" href="#at-the-beginning-there-were-threads" title="Permalink to this headline">¶</a></h1>
<blockquote>
<div><blockquote>
<div><p>In the first talk , “Talk #1 - Concurrency with Threads and Futures , Feb 8th 2020.”,
We discussed the evolution of concurrency in Python.</p>
<p>We started by analyzing chapter 17,  and first part of chapter 18 of Luciano Ramalho book  “Fluent Python” [6]
In chapter 17 “Concurrency and Features” , Luciano starts by explaining a sequential download . It is of course necessary
we can see a sequential example and how we could later improve it using concurrency.</p>
<p>Luciano starts  Chapter 18  with an example of Threads, and later move us to coroutines and finally async I/O.</p>
<p>We discussed chapter 17 and used the treads example in Chapter 18  to learn about Threads and Futures</p>
<p>To learn about Threads we fully discussed Raymond Hettinger talk, “Keynote on Concurrency, PyBay 2017” , where we
learned the complexity and perils that lure on the Threads world</p>
<p>Finally we were able to  arrive to below evolutionary conclusion in Table 1.</p>
<p>If you want to know more about this , we encourage you to search our talk or the resources mentioned.</p>
</div></blockquote>
<p>CONCURRENCY IN PYTHON : “Dealing with lots of things at once”
[6] Chapter 18th</p>
</div></blockquote>
<table class="colwidths-given docutils align-default" id="id1">
<caption><span class="caption-text">Table 1</span><a class="headerlink" href="#id1" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Python</p></th>
<th class="head"><p>Python 3.2/ 2011</p></th>
<th class="head"><p>Python 3.4/2014           Created by Guido</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
<td><p>current.futures ThreadpoolExecutor Context Manager</p></td>
<td><p>asyncio</p></td>
</tr>
<tr class="row-odd"><td><p>Threads, Locks,Semaphore,Event,Timer,Queue</p></td>
<td><p>Threads, Locks,Semaphore,Event,Timer,Queue</p></td>
<td><p>Coroutines, AsyncIO not blocking loops, cal backs</p></td>
</tr>
<tr class="row-even"><td><p>Multi Thread Processing</p></td>
<td><p>Multi Thread Processing</p></td>
<td><p>Single Thread Processing</p></td>
</tr>
</tbody>
</table>
<p>And here we are one month later to learn about async I/O , far away from the thread and blocked world we discussed
in February, entering into a new universe of cooperation multitasking  and event loops.</p>
<p>But then, we wonder  what is Async I/O and what Python have to do with this.?</p>
</div>
<div class="section" id="and-then-we-were-given-a-breath-of-life-async-i-o">
<h1>…And then we were given a breath of life Async I/O<a class="headerlink" href="#and-then-we-were-given-a-breath-of-life-async-i-o" title="Permalink to this headline">¶</a></h1>
<blockquote>
<div><p>What is async I/O ?</p>
<p>As per Wikipedia  “In computer science, asynchronous I/O (also non-sequential I/O) is a form of input/output
processing that permits other processing to continue before the transmission has finished”.</p>
<p>David Beazley, “Python Brasil 2015 keynote…” [8] , starts by recounting that Async I/O was implemented by C# a
long time ago . Łukasz Langa, “Thinking In Coroutines - PyCon 2016” [6] states that those who knows JavaScript/ NodeJS
async I/O should easily get the concept in Python.</p>
<p>So Async I/O is not a Python concept and indeed has been implemented in other languages a long time ago</p>
<p>Async I/O gives us the possibility of writing  concurrent programs , without using Threads. Threads belong to the OS
and as such are more expensive and less scalable than async I/O cooperative multitasking . So just using one thread ,
the main thread,  we are able to gain multiprocessing capability.</p>
<p>Before going any step further , this is the moment to take a look at Miguel Grinberg,  Asynchronous Python for the
Complete Beginner talk [2] where in just a few minutes , Miguel quickly describe the universe of async programing.</p>
<p>But then we want the details , the how this was possible, and indeed understand how async I/O works ?</p>
</div></blockquote>
<div class="section" id="how-the-heck-does-async-await-work-in-python-brett-cannon-11">
<h2>How the heck does async/await work in Python ? Brett  Cannon [11]<a class="headerlink" href="#how-the-heck-does-async-await-work-in-python-brett-cannon-11" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>When you feel afraid of not knowing enough about async I/O , it will be a relief to know that Brett  Cannon asked himself
the above question in  [11]. Once you know who he is you will feel and immediate peace of mind , on having
some doubts ( or maybe many ?) about async I/O. He had too at some time!!</p>
<p>David Beazley in [8] and [9], clearly describe the evolution of async I/O.
Meanwhile Brett  Cannon in [11] starts by taking us back to the origin and uses of ‘yield from’  in coroutines , is
David Beazley the one that takes us even further back and deeper , by starting for a differentiation between generators ,
an coroutines.</p>
<p>David Beazley  make a distinction that generators and generators function should be differentiated from coroutines in both
its intention and uses. We will see this distinction below.</p>
</div></blockquote>
</div>
<div class="section" id="iterables-and-iterator-and-generator-function">
<h2>Iterables and Iterator and Generator Function<a class="headerlink" href="#iterables-and-iterator-and-generator-function" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Generators are intrinsically linked to iteration. And that is the reason we start by analyzing the meaning of
iterable and iterator in Python.</p>
<p>Luciano Ramalho in [6] , Chapter 14 clearly defined iterable and iterator concepts. But before going there
take note the name of that Chapter :</p>
<p>“Iterables, Iterator and Generators”.</p>
<p>iterable:</p>
<p>Any object from which the iter built-in function can obtain an iterator. Objects implementing an __iter__ method
returning an iterator are iterable.
Sequences are always iterable; as are objects implementing a __getitem__ method that takes 0-based indexes.</p>
<p>It’s important to be clear about the relationship between iterables and iterators:
Python obtains iterators from iterables.</p>
<p>In page 418 [6], Luciano  stops to explain why Sequences are iterable and what the interpreter does when it needs to
iterate over an object</p>
<p>Then in the same Chapter in page 423 he gives us a definition of iterator</p>
<p>iterator:</p>
<p>Any object that implements the __next__ no-argument method that returns the next item in a series
or raises StopIteration when there are no more items. Python iterators also implement the __iter__ method
so they are iterable as well.</p>
<p>Now let see an example and carefully look that we have not used the keyword “yield” so far for anything:</p>
</div></blockquote>
</div>
<div class="section" id="generator-functions-yield-appears">
<h2>Generator Functions ( yield appears)<a class="headerlink" href="#generator-functions-yield-appears" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><blockquote>
<div><p>Python provides generator functions as a convenient shortcut to building iterators.
For this Python uses yield</p>
<p>Simple generator function countdown.py , taken from  David Beazley… [9]</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#countdown.py</span>
<span class="c1"># A simple generator function</span>

<span class="k">def</span> <span class="nf">countdown</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="nb">print</span> <span class="s2">&quot;Counting down from&quot;</span><span class="p">,</span> <span class="n">n</span>
    <span class="k">while</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">n</span>
        <span class="n">n</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="nb">print</span> <span class="s2">&quot;Done counting down&quot;</span>

<span class="c1"># Example use</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">countdown</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="nb">print</span> <span class="n">i</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Note the use of the yield to the left of the value. So yield is pausing execution of the countdown() function
and returning back  to the caller both:  the n value and the control. It is important to see that the state of
the countdown function , remains the same , so when the caller return control to the generator , the function
continuos execution after the yield n statement !!</p>
</div>
</div></blockquote>
<p>A Python function that has the yield keyword in its body is a generator function.
When this function is called it return a generator object. In other words a generator function is a generator
factory, Luciano pag 428 [6]</p>
<p>But ….</p>
<p>But people knew that if we took the “pausing” part of generators and added in a “send stuff
back in” aspect to them, Python would suddenly have the concept of coroutines in Python ..Brett [11]</p>
<p>When a generator yields , it keep sits state
So far we have seen generators being able to send values back to the caller.
It will change soon and we will see that they will be able to accept values from the caller.</p>
</div></blockquote>
</div>
<div class="section" id="coroutines-and-its-importance-in-async-operations">
<h2>Coroutines and its importance in async operations<a class="headerlink" href="#coroutines-and-its-importance-in-async-operations" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul>
<li><p>The origins of the yield from keyword</p>
<blockquote>
<div><p>In  [6] , Chapter 16 Page 480, Luciano Ramalho  explains to us  ” How Coroutines evolved form Generators” :
On PEP 342 and PEP 380 , Luciano continues in [6],  .send() , throw() and .close() methods were added that
allowed a caller to send() a datum into the generator , thrown and exception to be handle inside the generator,
and terminate it.</p>
<p>PEP 380 , added yield from syntax. that allows a generator , continues Luciano  in [6] in the same page 480.
We can go deeper on the details of PEP 380, created by Gregory Ewing reading [16]</p>
<p>Coroutines are just special generators …. You sent values into</p>
<p>Coroutines are very similar to generators in Python: they both use yield.
Just the meaning of yield implies to let things go.To stop and let other continuous. So yield keyword
has an asynchronous meaning. Brett [8] .
Coroutines suspend execution in the yield statement and pass control to the caller
along with any value to the right of yield.
Normal coroutines in python use yield to wait to receive an elements from the caller. Usually yield is to the right
The caller send data to the coroutine using send.
Coroutines are functions whose execution you can pause.</p>
<blockquote>
<div><p>We could see some examples of use of coroutines now , but what will be really useful is to see David Beazley examples
in A Curious Course on Coroutines [9] …, Part 1 : Introduction to Generators and Coroutines</p>
</div></blockquote>
</div></blockquote>
</li>
</ul>
<blockquote>
<div><p>Then looking at Chapter [2] on David Bealey [9] , example copipe.py we will see how how to hook up a pipeline with
coroutines.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Note that stacking coroutines , meaning having one coroutine doing something passing the result of its operation
to another coroutine so it does another things, with that kind of structure , we could get pretty powerful
functionality. “yield from” will allow us to successfully concatenate coroutines and get messages passed back and
forth from the caller to any coroutine in the pipe.</p>
</div>
<p>Now is time we can understand and see “yield from” in Action , but taken a look to [6] Example 16-17, “Fluent Python”,
Luciano Ramalho Page [496]</p>
</div></blockquote>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">averager</span><span class="p">():</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">average</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">term</span> <span class="o">=</span> <span class="k">yield</span>
        <span class="k">if</span> <span class="n">term</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="k">break</span>
        <span class="n">total</span> <span class="o">+</span> <span class="o">=</span> <span class="n">term</span>
        <span class="n">count</span> <span class="o">+</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">average</span> <span class="o">=</span> <span class="n">total</span> <span class="o">/</span> <span class="n">count</span>
        <span class="k">return</span> <span class="n">Result</span> <span class="p">(</span> <span class="n">count</span> <span class="p">,</span> <span class="n">average</span> <span class="p">)</span>

 <span class="c1"># the delegating generator</span>
 <span class="k">def</span> <span class="nf">grouper</span> <span class="p">(</span> <span class="n">results</span> <span class="p">,</span> <span class="n">key</span> <span class="p">):</span>
    <span class="k">while</span> <span class="kc">True</span> <span class="p">:</span>
        <span class="n">results</span> <span class="p">[</span> <span class="n">key</span> <span class="p">]</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">averager</span> <span class="p">(</span> <span class="p">)</span>

 <span class="c1"># the client code, a.k.a. the caller</span>

 <span class="k">def</span> <span class="nf">main</span> <span class="p">(</span> <span class="n">data</span> <span class="p">):</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span> <span class="p">}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">data</span> <span class="o">.</span> <span class="n">items</span> <span class="p">(</span> <span class="p">):</span>
    <span class="n">group</span> <span class="o">=</span> <span class="n">grouper</span> <span class="p">(</span> <span class="n">results</span> <span class="p">,</span> <span class="n">key</span> <span class="p">)</span>
    <span class="nb">next</span> <span class="p">(</span> <span class="n">group</span> <span class="p">)</span>
    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
        <span class="n">group</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="c1"># important!</span>

    <span class="c1"># print(results) # uncomment to debug</span>
    <span class="n">report</span> <span class="p">(</span> <span class="n">results</span> <span class="p">)</span>

    <span class="c1"># output report</span>
    <span class="k">def</span> <span class="nf">report</span> <span class="p">(</span> <span class="n">results</span> <span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">sorted</span> <span class="p">(</span> <span class="n">results</span> <span class="o">.</span> <span class="n">items</span> <span class="p">(</span> <span class="p">)</span> <span class="p">):</span>
            <span class="n">group</span> <span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">key</span> <span class="o">.</span> <span class="n">split</span> <span class="p">(</span> <span class="s1">&#39; ; &#39;</span> <span class="p">)</span>
            <span class="nb">print</span> <span class="p">(</span> <span class="s1">&#39; </span><span class="si">{:2}</span><span class="s1"> </span><span class="si">{:5}</span><span class="s1"> averaging </span><span class="si">{:.2f}{}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                      <span class="n">result</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">average</span><span class="p">,</span> <span class="n">unit</span><span class="p">))</span>

 <span class="n">data</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39; girls;kg &#39;</span><span class="p">:</span>
                <span class="p">[</span> <span class="mf">40.9</span> <span class="p">,</span> <span class="mf">38.5</span> <span class="p">,</span> <span class="mf">44.3</span> <span class="p">,</span> <span class="mf">42.2</span> <span class="p">,</span> <span class="mf">45.2</span> <span class="p">,</span> <span class="mf">41.7</span> <span class="p">,</span> <span class="mf">44.5</span> <span class="p">,</span> <span class="mf">38.0</span> <span class="p">,</span> <span class="mf">40.6</span> <span class="p">,</span> <span class="mf">44.5</span> <span class="p">]</span> <span class="p">,</span>
          <span class="s1">&#39; girls;m &#39;</span><span class="p">:</span>
                <span class="p">[</span> <span class="mf">1.6</span> <span class="p">,</span> <span class="mf">1.51</span> <span class="p">,</span> <span class="mf">1.4</span> <span class="p">,</span> <span class="mf">1.3</span> <span class="p">,</span> <span class="mf">1.41</span> <span class="p">,</span> <span class="mf">1.39</span> <span class="p">,</span> <span class="mf">1.33</span> <span class="p">,</span> <span class="mf">1.46</span> <span class="p">,</span> <span class="mf">1.45</span> <span class="p">,</span> <span class="mf">1.43</span> <span class="p">]</span> <span class="p">,</span>
           <span class="s1">&#39; boys;kg &#39;</span><span class="p">:</span>
                 <span class="p">[</span> <span class="mf">39.0</span> <span class="p">,</span> <span class="mf">40.8</span> <span class="p">,</span> <span class="mf">43.2</span> <span class="p">,</span> <span class="mf">40.8</span> <span class="p">,</span> <span class="mf">43.1</span> <span class="p">,</span> <span class="mf">38.6</span> <span class="p">,</span> <span class="mf">41.4</span> <span class="p">,</span> <span class="mf">40.6</span> <span class="p">,</span> <span class="mf">36.3</span> <span class="p">]</span> <span class="p">,</span>
           <span class="s1">&#39; boys;m &#39;</span><span class="p">:</span>
                 <span class="p">[</span> <span class="mf">1.38</span> <span class="p">,</span> <span class="mf">1.5</span> <span class="p">,</span> <span class="mf">1.32</span> <span class="p">,</span> <span class="mf">1.25</span> <span class="p">,</span> <span class="mf">1.37</span> <span class="p">,</span> <span class="mf">1.48</span> <span class="p">,</span> <span class="mf">1.25</span> <span class="p">,</span> <span class="mf">1.49</span> <span class="p">,</span> <span class="mf">1.46</span> <span class="p">]</span> <span class="p">,</span> <span class="p">}</span>

 <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39; __main__ &#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<p>We can easily see now the power of “yield from” and how this keywords will allow us to extract values and send
values directly to the subgenerator, which yield data back at the caller.</p>
</div></blockquote>
</div>
<div class="section" id="interlude-generators-are-not-coroutines">
<h2>Interlude : Generators are not Coroutines<a class="headerlink" href="#interlude-generators-are-not-coroutines" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>David Beazley minute 30:42 of Curious Course on Coroutines and Concurrency [9]</p>
<p>Coroutines evolved from generators.From coroutines a new syntax gave birth to async and await keywords
and that is the reason we have taken a look to all that here so far.</p>
<p>But as David Beazley quoted in above references [9], generators are not coroutines.
Below Table show the differences.</p>
<table class="colwidths-given docutils align-default" id="id2">
<caption><span class="caption-text">Table 2 Differences between GENERATORS and COROUTINES</span><a class="headerlink" href="#id2" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 35%" />
<col style="width: 65%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>GENERATORS</p></th>
<th class="head"><p>COROUTINES</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Produce data</p></td>
<td><p>Consume data</p></td>
</tr>
<tr class="row-odd"><td><p>Related to iteration</p></td>
<td><p>Nothing to do with iteration,even when producing values and Related to async behavior</p></td>
</tr>
</tbody>
</table>
<p>Python’s coroutines, are special functions that give up control to the caller without losing their state [13]
They allow to return information from a pipe of multiple coroutines using yield from
They consume data and evolved from generators</p>
</div></blockquote>
<p>Hellmann, Doug. The Python 3 Standard Library by Example (Developer’s Library) . Pearson Education. Kindle Edition.</p>
</div>
<div class="section" id="event-loops">
<h2>Event Loops :<a class="headerlink" href="#event-loops" title="Permalink to this headline">¶</a></h2>
<p>Doug Hellman in his mater book “The Python 3 Standard Library by Example”  (Developer’s Library) 1st Edition
chapter 10.5 explains to us what an Event Loop is:</p>
<p>“Event loop, a first-class object that is responsible for efficiently handling I/O events, system events,
and application context changes. Several loop implementations are provided, to take advantage of the
operating systems’ capabilities efficiently. While a reasonable default is usually selected automatically,
it is also possible to pick a particular event loop implementation from within the application”. [13]</p>
<p>Python documentation describes the event loop as follow:
“Event loops run asynchronous tasks and callbacks, perform network IO operations, and run subprocesses”. [14]</p>
<p>“In computer science, the event loop is a programming construct or design pattern that waits for and dispatches
events or messages in a program. The event loop works by making a request to some internal or external
“event provider” (that generally blocks the request until an event has arrived),
then calls the relevant event handler (“dispatches the event”).</p>
<p>The event loop is also sometimes referred to as the message dispatcher, message loop, message pump, or run loop.”</p>
<p>MDN gives us the following definition of JavaScript event loop:</p>
<p>“JavaScript has a concurrency model based on an event loop,
which is responsible for executing the code, collecting and processing events,
and executing queued sub-tasks. “</p>
<p>In any case an event loop is as its name says , is a loop. In Python we can implement loops with something so
simple as a while statement !!. Also we can do it using a context Manager, etc.</p>
<p>In brief the Event Loop is an important part of any Async I/O architecture, and in Python this is also the case.</p>
<p>Specifically the asyncio module , one of many async i/o implementations in Python , create the event loop in the
BaseDefaultEventLoopPolicy. This event loop runs in its own thread and what we expect from it
( efficiency, simplicity and responsability in task delegation ) we get it</p>
<p>See below some lines of the source code for the method get_event_loop()</p>
<p><a class="reference external" href="https://github.com/python/cpython/blob/9ce361d3bb15cf49b82fa03e3e593d7cbd8ee1ff/Lib/asyncio/events.py#L205">BaseDefaultEventLoop</a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BaseDefaultEventLoopPolicy</span><span class="p">(</span><span class="n">AbstractEventLoopPolicy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Default policy implementation for accessing the event loop.</span>
<span class="sd">    In this policy, each thread has its own event loop.  However, we</span>
<span class="sd">    only automatically create an event loop by default for the main</span>
<span class="sd">    thread; other threads by default have no event loop.</span>
<span class="sd">    Other policies may have different rules (e.g. a single global</span>
<span class="sd">    event loop, or automatically creating an event loop per thread, or</span>
<span class="sd">    using some other notion of context to which an event loop is</span>
<span class="sd">    associated).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_loop_factory</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">class</span> <span class="nc">_Local</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">local</span><span class="p">):</span>
        <span class="n">_loop</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">_set_called</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Local</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_event_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the event loop for the current context.</span>
<span class="sd">        Returns an instance of EventLoop or raises an exception.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">_loop</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span>
                <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">_set_called</span> <span class="ow">and</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">(),</span> <span class="n">threading</span><span class="o">.</span><span class="n">_MainThread</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_event_loop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_event_loop</span><span class="p">())</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">_loop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;There is no current event loop in thread </span><span class="si">%r</span><span class="s1">.&#39;</span>
                               <span class="o">%</span> <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">_loop</span>
</pre></div>
</div>
<p>By the other hands David Beazley curio library use as event loop an Object he called the Kernel.
We ask the Kernel to run and pass as a parameter to it  a coroutine.
One more time the Kernel ( Event Loop) has only limited coordination and functionality and is build on top of simple
data structures, threads.Event object (real threads) etc</p>
<p><a class="reference external" href="https://github.com/dabeaz/curio/blob/master/curio/kernel.py">The curio Event Loop (Kernel) run function</a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">corofunc</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">with_monitor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">selector</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">debug</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">activations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kernel_extra</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Run the curio kernel with an initial task and execute until all</span>
<span class="sd">    tasks terminate.  Returns the task&#39;s final result (if any). This</span>
<span class="sd">    is a convenience function that should primarily be used for</span>
<span class="sd">    launching the top-level task of a curio-based application.  It</span>
<span class="sd">    creates an entirely new kernel, runs the given task to completion,</span>
<span class="sd">    and concludes by shutting down the kernel, releasing all resources used.</span>

<span class="sd">    Don&#39;t use this function if you&#39;re repeatedly launching a lot of</span>
<span class="sd">    new tasks to run in curio. Instead, create a Kernel instance and</span>
<span class="sd">    use its run() method instead.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">kernel</span> <span class="o">=</span> <span class="n">Kernel</span><span class="p">(</span><span class="n">selector</span><span class="o">=</span><span class="n">selector</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span> <span class="n">activations</span><span class="o">=</span><span class="n">activations</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kernel_extra</span><span class="p">)</span>

    <span class="c1"># Check if a monitor has been requested</span>
    <span class="k">if</span> <span class="n">with_monitor</span> <span class="ow">or</span> <span class="s1">&#39;CURIOMONITOR&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">.monitor</span> <span class="kn">import</span> <span class="n">Monitor</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">Monitor</span><span class="p">(</span><span class="n">kernel</span><span class="p">)</span>
        <span class="n">kernel</span><span class="o">.</span><span class="n">_call_at_shutdown</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="n">kernel</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">kernel</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">kernel</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">corofunc</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</pre></div>
</div>
<p>Ok so we have mentioned 3 Event loops two in Python and one in javascript
the asyncio event loop is able to run asynchornous code ( threads , futures) as well as async i/o not blocking code</p>
<p>This is taken from the Python documentation</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">concurrent.futures</span>

<span class="k">def</span> <span class="nf">blocking_io</span><span class="p">():</span>
    <span class="c1"># File operations (such as logging) can block the</span>
    <span class="c1"># event loop: run them in a thread pool.</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/dev/urandom&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">cpu_bound</span><span class="p">():</span>
    <span class="c1"># CPU-bound operations will block the event loop:</span>
    <span class="c1"># in general it is preferable to run them in a</span>
    <span class="c1"># process pool.</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="mi">7</span><span class="p">))</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>

    <span class="c1">## Options:</span>

    <span class="c1"># 1. Run in the default loop&#39;s executor:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span> <span class="n">blocking_io</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;default thread pool&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

    <span class="c1"># 2. Run in a custom thread pool:</span>
    <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">()</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span>
            <span class="n">pool</span><span class="p">,</span> <span class="n">blocking_io</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;custom thread pool&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

    <span class="c1"># 3. Run in a custom process pool:</span>
    <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ProcessPoolExecutor</span><span class="p">()</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span>
            <span class="n">pool</span><span class="p">,</span> <span class="n">cpu_bound</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;custom process pool&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</pre></div>
</div>
<p>As we can see we use the asyncio Event Loop was used to run  Process and Threads!!</p>
<p>So lets see some more examples of Even Loops ,</p>
<p>From Python asyncio docs :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">asyncio</span>

<span class="k">def</span> <span class="nf">hello_world</span><span class="p">(</span><span class="n">loop</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A callback to print &#39;Hello World&#39; and stop the event loop&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Hello World&#39;</span><span class="p">)</span>
    <span class="n">loop</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

<span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>

<span class="c1"># Schedule a call to hello_world()</span>
<span class="n">loop</span><span class="o">.</span><span class="n">call_soon</span><span class="p">(</span><span class="n">hello_world</span><span class="p">,</span> <span class="n">loop</span><span class="p">)</span>

<span class="c1"># Blocking call interrupted by loop.stop()</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">loop</span><span class="o">.</span><span class="n">run_forever</span><span class="p">()</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">loop</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>This is still another simple example</p>
</div>
<div class="section" id="his-name-is-yuri-selivanov-or-async-await-to-take-us-outside-of-the-chaos">
<h2>His name is Yuri Selivanov, or,  “async / await to take us outside of the chaos”<a class="headerlink" href="#his-name-is-yuri-selivanov-or-async-await-to-take-us-outside-of-the-chaos" title="Permalink to this headline">¶</a></h2>
<p>PEP 492 [13]  was introduced by Yuri Selivanov. to save us the rest of the mortals from the confusions and darkness.
You can see also Yuri Selivanov in our first reference here.
Go and take a look at Python PEP and search async and its authors. You will find its name close to multiples PEP</p>
<p>In the abstract we can read</p>
<p>” …[PEP 492] It is proposed to make coroutines a proper standalone concept in Python, and introduce new supporting syntax.
The ultimate goal is to help establish a common, easily approachable, mental model of asynchronous
programming in Python and make it as close to synchronous programming as possible.</p>
<p>This PEP assumes that the asynchronous tasks are scheduled and coordinated by an Event Loop similar
to that of stdlib module asyncio.events.AbstractEventLoop. While the PEP is not tied to any specific Event Loop
implementation, it is relevant only to the kind of coroutine that uses yield as a signal to the scheduler,
indicating that the coroutine will be waiting until an event (such as IO) is completed.”</p>
<p>In brief : async await is a new syntax created in Python to work with coroutines, just to make it clear it is a coroutine
( and as we already know reinforce the idea of asymmetric behavior) , and not a generator.</p>
<p>Dusty Phillips, in [14] (p. 295) note:</p>
<p>There is an alternate syntax for coroutines using the async and await keywords. The syntax makes it clearer that
the code is a coroutine and further breaks the deceiving symmetry between coroutines and generators.
The syntax doesn’t work very well without building a full event loop …</p>
<p>So in the new world of async, and in the newest version of Python  , coroutines reinforce the sense of
asynchronous behavior by using:</p>
<ul class="simple">
<li><p>async –&gt; instead of –&gt; “yield”</p></li>
<li><p>await –&gt; instead of –&gt; “yield from” ( This transfer control back to the caller, in asyncio world ,the Event Loop)</p></li>
<li><p>“async def” is now used to declare a native coroutine</p></li>
<li><p>“asyn def” functions are always coroutines, even without await expressions</p></li>
<li><p>coroutine object is the object returned when we call a coroutine(like generator objects are returned from generators)</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">asyncio</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">echo_server</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Serving on localhost:8000&#39;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">start_server</span><span class="p">(</span><span class="n">handle_connection</span><span class="p">,</span>
                               <span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">8000</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">handle_connection</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">writer</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;New connection...&#39;</span><span class="p">)</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8192</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sending </span><span class="si">{:.10}</span><span class="s1">... back&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">echo_server</span><span class="p">())</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">loop</span><span class="o">.</span><span class="n">run_forever</span><span class="p">()</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">loop</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>Above is the example given in the PEP 492.</p>
<p>Now let’s see and discuss some more example. Luciano in [6] , Exercise 18=2, takes the time of creating teh same
script using asyncio , and curio .</p>
<p>It is in the GitHub project of the book not in the book itself</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="c1"># spinner_curio.py</span>

<span class="c1"># credits: Example by Luciano Ramalho inspired by</span>
<span class="c1"># Michele Simionato&#39;s multiprocessing example in the python-list:</span>
<span class="c1"># https://mail.python.org/pipermail/python-list/2009-February/538048.html</span>
<span class="kn">import</span> <span class="nn">curio</span>

<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">sys</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">spin</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>  <span class="c1"># &lt;1&gt;</span>
    <span class="n">write</span><span class="p">,</span> <span class="n">flush</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span>
    <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">cycle</span><span class="p">(</span><span class="s1">&#39;|/-</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">):</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">char</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">msg</span>
        <span class="n">write</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
        <span class="n">flush</span><span class="p">()</span>
        <span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\x08</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">curio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="o">.</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># &lt;2&gt;</span>
        <span class="k">except</span> <span class="n">curio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>  <span class="c1"># &lt;3&gt;</span>
            <span class="k">break</span>
    <span class="n">write</span><span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\x08</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">slow_function</span><span class="p">():</span>  <span class="c1"># &lt;4&gt;</span>
    <span class="c1"># pretend waiting a long time for I/O</span>
    <span class="k">await</span> <span class="n">curio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># &lt;5&gt;</span>
    <span class="k">return</span> <span class="mi">42</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">supervisor</span><span class="p">():</span>  <span class="c1"># &lt;6&gt;</span>
    <span class="n">spinner</span> <span class="o">=</span> <span class="k">await</span> <span class="n">curio</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">spin</span><span class="p">(</span><span class="s1">&#39;thinking!&#39;</span><span class="p">))</span>  <span class="c1"># &lt;7&gt;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;spinner object:</span><span class="se">\n</span><span class="s1"> &#39;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">spinner</span><span class="p">))</span>  <span class="c1"># &lt;8&gt;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">slow_function</span><span class="p">()</span>  <span class="c1"># &lt;9&gt;</span>
    <span class="k">await</span> <span class="n">spinner</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>  <span class="c1"># &lt;10&gt;</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">curio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">supervisor</span><span class="p">)</span>  <span class="c1"># &lt;12&gt;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Answer:&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>and now the same example using asyncio with await and the new coroutine definitions asyn def</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="c1"># spinner_await.py</span>

<span class="c1"># credits: Example by Luciano Ramalho inspired by</span>
<span class="c1"># Michele Simionato&#39;s multiprocessing example in the python-list:</span>
<span class="c1"># https://mail.python.org/pipermail/python-list/2009-February/538048.html</span>

<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">sys</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">spin</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>  <span class="c1"># &lt;1&gt;</span>
    <span class="n">write</span><span class="p">,</span> <span class="n">flush</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span>
    <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">cycle</span><span class="p">(</span><span class="s1">&#39;|/-</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">):</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">char</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">msg</span>
        <span class="n">write</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
        <span class="n">flush</span><span class="p">()</span>
        <span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\x08</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="o">.</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># &lt;2&gt;</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>  <span class="c1"># &lt;3&gt;</span>
            <span class="k">break</span>
    <span class="n">write</span><span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\x08</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">slow_function</span><span class="p">():</span>  <span class="c1"># &lt;4&gt;</span>
    <span class="c1"># pretend waiting a long time for I/O</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># &lt;5&gt;</span>
    <span class="k">return</span> <span class="mi">42</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">supervisor</span><span class="p">():</span>  <span class="c1"># &lt;6&gt;</span>
    <span class="n">spinner</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span><span class="n">spin</span><span class="p">(</span><span class="s1">&#39;thinking!&#39;</span><span class="p">))</span>  <span class="c1"># &lt;7&gt;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;spinner object:&#39;</span><span class="p">,</span> <span class="n">spinner</span><span class="p">)</span>  <span class="c1"># &lt;8&gt;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">slow_function</span><span class="p">()</span>  <span class="c1"># &lt;9&gt;</span>
    <span class="n">spinner</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>  <span class="c1"># &lt;10&gt;</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>  <span class="c1"># &lt;11&gt;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">supervisor</span><span class="p">())</span>  <span class="c1"># &lt;12&gt;</span>
    <span class="n">loop</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Answer:&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>We can see that both library make use of async / await syntax and each one implement the same functionality ,
an Async I/O execution one using curio and anotehr using asyncio</p>
</div>
<div class="section" id="so-at-the-end-what-we-need-to-know-so-far">
<h2>So at the end, what we need to know so far<a class="headerlink" href="#so-at-the-end-what-we-need-to-know-so-far" title="Permalink to this headline">¶</a></h2>
<p>Before trying to understand anything else  we need to go to David Beazley’s curio GitHub implementation
<a class="reference external" href="https://github.com/dabeaz/curio">here</a>.
No worries , we are not going to try to understand it. But  we will read something really interesting :</p>
<blockquote>
<div><p>“Curio - There Are Many Async Libraries, But This One is Mine”</p>
</div></blockquote>
<p>Unfortunately on Thursday 20th, 2020  at around 7:00pm ET, just a few days after I had writen this part of the conference,
David Beazley changed the message  of curio to Curio - “It’s the Sauce!”</p>
<p>Now you need to go to Brett Cannon essay in [7]. and  ,read this twice:</p>
<p>[7]….In that talk, David pointed out that async/await is really an API for asynchronous programming
(which he reiterated to me on Twitter). What David means by this is that people shouldn’t think that async/await
as synonymous with asyncio, but instead think that asyncio is a framework that can utilize the async/await
API for asynchronous programming.</p>
<p>David Beazley actually believes this idea of async/await being an asynchronous programming API that he has created
the curio project to implement his own event loop. This has helped make it clear to me that async/await allows
Python to provide the building blocks for asynchronous programming, but without tying you to a specific event
loop or other low-level details (unlike other programming languages which integrate the event loop into the
language directly). This allows for projects like curio to not only operate differently at a lower level
(e.g., asyncio uses future objects as the API for talking to its event loop while curio uses tuples), but to also
have different focuses and performance characteristics (e.g., asyncio has an entire framework for implementing
transport and protocol layers which makes it extensible while curio is simpler and expects the user to worry
about that kind of thing but also allows it to run faster).”</p>
<p>So at this point we should be clear of the following:</p>
<blockquote>
<div><ul class="simple">
<li><p>What is Async I/O ? (read above we discussed this concept before)</p></li>
<li><p>What is an Event Loop ? (read above we discussed this concept before)</p></li>
<li><p>asyncio is a framework that can utilize the async/await API for asynchronous programming.</p></li>
<li><p>async/await is an  asynchronous programming API</p></li>
<li><p>async/await allows Python to provide the building blocks for asynchronous programming</p></li>
</ul>
</div></blockquote>
<p>Python async I/O ecosystem as off February 2020</p>
<blockquote>
<div><ul class="simple">
<li><p>Coroutines with async and await syntax</p></li>
<li><p>Asynchronous Generators</p></li>
<li><p>Asynchronous Comprehensions</p></li>
<li><p>Asynchronous IO Support Rebooted: the “asyncio” Module</p></li>
<li><p>Asynchronous I/O For subprocess.Popen</p></li>
<li><p>third party libraries : Twisted ,  gevent</p></li>
<li><p>curio</p></li>
<li><p>trio</p></li>
<li><p>aiohttp</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="andrew-svetlov-aiohttp">
<h2>Andrew Svetlov : aiohttp<a class="headerlink" href="#andrew-svetlov-aiohttp" title="Permalink to this headline">¶</a></h2>
<p>In order to use asyncio, we must use libraries that are not blocking
It means that those libraries or frameworks, need in turn to use asyncio’s implementation of all I/O functions !!!
So let say we want to use asyncio to get a web site , we just can not do</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>

<span class="n">asyn</span> <span class="k">def</span> <span class="nf">fetch</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="o">....</span>
    <span class="k">await</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="o">....</span>
</pre></div>
</div>
<p>The reason for this is that requests is not awaitable .Requests comes from the another universe, the universe
of blocking and uses sockets() that is blocking by nature, and as such we can not use it. So then what we are going to
do.</p>
<p>Fortunately Andrew Svetlov created aiohttp and we can use it for cases like this.
Andrew Svetlov and Mariatta Wijaya, in [4] and [5], provided us with some examples we will use here</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, David Gutierrez

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>